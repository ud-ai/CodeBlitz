(()=>{chrome.runtime.onInstalled.addListener(()=>{console.log("CodeBlitz Extension Installed")});chrome.runtime.onMessage.addListener((o,l,s)=>{if(o.type==="AI_QUERY"){let a=o.prompt||o.message,i=o.problemStatement||"",c=o.mode==="interview"?"interview":"normal";return(async()=>{try{let e=new AbortController,n=setTimeout(()=>e.abort(),25e3);try{let t=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":"AIzaSyDXj0nlNs5Z6S0OpEBSWdGh29hw9IrBUOo"},body:JSON.stringify({contents:[{role:"user",parts:[{text:i?`Problem context:
${i}

User message:
${a}`:a}]}],systemInstruction:{role:"system",parts:[{text:c==="interview"?"You are an expert LeetCode interviewer and mentor. Conduct a conversational interview: 1) ask one concise question at a time; 2) never give full solutions; 3) provide granular hints based on user's last message; 4) encourage verbal reasoning; 5) keep replies under 120 words; 6) include at most one follow-up question. If the user asks for examples, give minimal examples, not full code.":"You are a helpful coding mentor. Provide clear, concise guidance and brief code snippets only when explicitly requested. Prefer stepwise reasoning, bullet points, and keep answers actionable under 150 words."}]},generationConfig:{temperature:c==="interview"?.6:.7,maxOutputTokens:700}}),signal:e.signal});if(clearTimeout(n),!t.ok)throw new Error(`API responded with status: ${t.status}`);let r=await t.json();return console.log("Gemini response data:",r),r?.candidates&&r.candidates.length>0&&r.candidates[0].content?.parts&&r.candidates[0].content.parts.length>0?{answer:r.candidates[0].content.parts[0].text.trim()}:r?.error?(console.error("Gemini API Error:",r.error),{answer:"Gemini API error: "+r.error.message}):{answer:"No valid response received from AI."}}catch(t){throw t instanceof Error&&t.name==="AbortError"?new Error("Request timed out. Please try again."):t}finally{clearTimeout(n)}}catch(e){return console.error("Fetch error:",e),{error:e instanceof Error?e.message:String(e),answer:"Network or Gemini error: "+(e instanceof Error?e.message:String(e))}}})().then(e=>{try{s(e)}catch(n){console.error("Error sending response:",n)}}).catch(e=>{console.error("Unexpected error in fetchData:",e);try{s({answer:"Unexpected error: "+(e instanceof Error?e.message:String(e))})}catch(n){console.error("Error sending error response:",n)}}),!0}});})();
